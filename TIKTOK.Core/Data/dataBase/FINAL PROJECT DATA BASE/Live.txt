create table Live(
ID NUMBER GENERATED BY DEFAULT AS IDENTITY CONSTRAINT PK_Live PRIMARY Key,
RoomName Varchar2(255),
startLive Date,
endLive Date,
userId Number Constraint Fk_live_User REFERENCES USER1(ID) on DELETE CASCADE
);



CREATE OR REPLACE PACKAGE  Live_PACKAGE AS
    PROCEDURE AddLive(P_RoomName IN VARCHAR DEFAULT NULL
    ,P_startLive IN DATE DEFAULT NULL
    ,P_userId IN NUMBER DEFAULT NULL);
    
    PROCEDURE EndLive(p_userID IN Number DEFAULT NULL,p_endLive In Date DEFAULT NULL);
    
    PROCEDURE GetActiveLive;
    
End Live_PACKAGE;



CREATE OR REPLACE PACKAGE BODY Live_PACKAGE AS
    
    PROCEDURE AddLive(P_RoomName IN VARCHAR DEFAULT NULL
    ,P_startLive IN DATE DEFAULT NULL
    ,P_userId IN NUMBER DEFAULT NULL)
    IS
    BEGIN
             EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT=''DD-MON-YYYY HH24:MI:SS''';
            INSERT INTO Live VALUES(DEFAULT,P_RoomName,To_DATE(P_startLive,'DD-MM-YYYY HH24:MI:SS'),null,P_userId); 
            COMMIT;
    END AddLive;

    PROCEDURE EndLive(p_userID IN Number DEFAULT NULL,p_endLive In Date DEFAULT NULL)IS
    Begin
        EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT=''DD-MON-YYYY HH24:MI:SS''';
        Update Live Set EndLive = To_DATE(p_endLive,'DD-MM-YYYY HH24:MI:SS')
        Where Userid = p_userID And EndLive is null ;
        commit;
    End EndLive;
    
    PROCEDURE GetActiveLive IS
        live_all SYS_REFCURSOR;
    Begin
        OPEN live_all FOR SELECT u.userName,u.imagePath,l.* FROM Live l
        Inner Join User1 u ON u.id = l.userid
         WHERE endLive IS null;
        dbms_sql.return_result(live_all);
    End GetActiveLive;
    
END Live_PACKAGE;

